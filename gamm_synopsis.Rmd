---
title: "SMB II - Notes to statistical analysis"
author: "Kenneth Thor√∏ Martinsen"
date: "Apr. 14 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

source("rawdata.R")

gam_list <- readRDS(paste0(modeling_path,"gam_list.rds"))

gam_nocorr <- gam_list$nocorr
gam_car <- gam_list$gam_car
gam_gaus <- gam_list$gam_gaus

mod_sel <- readRDS(paste0(modeling_path, "gam_model_selection.rds"))

gam_best <- readRDS(paste0(modeling_path,"gam_best.rds"))
```

# Investigating the influence of wind on water column k~z~ using GAM analysis

Brief notes and walk-trough of the statistical analysis for the manuscript titled *"Wind drives spatio-temporal variability of light attenuation in a large, shallow re-established lake"* conducted as part of the SMB II course. 

## Summary of model data

The response variable k~z~ is log-transformed. 

```{r, echo=FALSE}
summary(model_df)
```

Histograms of predictor variables:

```{r, echo=FALSE}
model_df %>% 
  select(-date, -site, -year_fact, -contains("lag")) %>% 
  gather(variable, value) %>% 
  na.omit() %>% 
  ggplot(aes(value)) +
  geom_histogram()+
  facet_wrap(variable~., scales = "free")
```

## Evaluate smoothing of predictor terms

First, test if predictors terms should be smoothed. Second, test the degrees of smoothing (k) required.
Summaries not shown. 

```{r, eval=FALSE}
#Initial gam - check smoothing of predictor terms
gam_1 <- gam(kz_hobo ~
               s(site, bs = "re")+
               s(wnd_mean)+
               s(wnd_mean_lag1)+
               s(wnd_mean_lag2)+
               s(wnd_mean_lag3)+
               s(wnd_dir, bs = "cc")+
               ti(wnd_mean, wnd_dir, bs=c("tp", "cc"))+
               s(doy, by=year_fact)+
               year,
             data = model_df)
summary(gam_2)

#Make non significant smooth terms parametric/linear terms instead
gam_2 <- gam(kz_hobo ~
               s(site, bs = "re")+
               s(wnd_mean)+
               wnd_mean_lag1+
               wnd_mean_lag2+
               wnd_mean_lag3+
               s(wnd_dir, bs = "cc", k=15)+
               ti(wnd_mean, wnd_dir, bs=c("tp", "cc"))+
               s(doy, by=year_fact, k=15)+
               year,
             data = model_df)
summary(gam_2)

#Check k-values by plotting residuals vs each smoothed predictor and change gam_2 model accordingly
rsd <- residuals(gam_2)
gam(rsd~s(wnd_mean, bs = "cs"), gamma=1.4, data=model_df)
gam(rsd~s(wnd_dir, bs = "cs", k = 15), gamma=1.4, data=model_df) 
gam(rsd~ti(wnd_mean, wnd_dir, bs="cs"), gamma=1.4, data=model_df) 
gam(rsd~s(doy, by=year_fact, k=15, bs="cs"), gamma=1.4, data=model_df) #increase k in gam_2

```

## Fit GAMMs and compare correlation structures

Compare GAMMs with different correlation structures: no structure, corCAR1 (autocorrelation structure of order 1, with a continuous time covariate) and corGAUS (Gaussian spatial correlation structure). Model comparison using AIC.

```{r, eval=FALSE}
form <- formula(kz_hobo ~
                  s(site, bs = "re")+
                  s(wnd_mean)+
                  wnd_mean_lag1+
                  wnd_mean_lag2+
                  wnd_mean_lag3+
                  s(wnd_dir, bs = "cc", k=15)+
                  ti(wnd_mean, wnd_dir, bs=c("tp", "cc"))+
                  s(doy, by=year_fact, k=15)+
                  year)

gam_nocorr <- gamm(form, 
                   data = model_df)

gam_car <- gamm(form,
                correlation = corCAR1(form = ~ as.numeric(date)|site), 
                data = model_df)

gam_gaus <- gamm(form, 
                 correlation = corGaus(form = ~ as.numeric(date)|site), 
                 data = model_df)

```

Compare the fitted models:

```{r}
anova(gam_nocorr$lme, gam_car$lme, gam_gaus$lme)
```

Use model with corCAR1 correlation structure onward in analysis.

## Model selection

Compare models with different combinations of predictor variables. Only different combinations of parametric/linear terms are compared, smoothed terms are always significant.

```{r, eval=FALSE}
#Compare candidate models by AIC
gam_car_wrap <- uGamm(form,
                      correlation = corCAR1(form = ~ as.numeric(date)|site),
                      data = model_df)

cl <- makeCluster(4, type = "SOCK")
clusterExport(cl, "model_df")

mod_sel <- pdredge(gam_car_wrap,
                   cluster = cl,
                   rank = "AIC",
                   fixed = c('s(site, bs = "re")',
                             's(wnd_mean)',
                             's(wnd_dir, bs = "cc", k = 15)',
                             's(doy, by = year_fact, k = 15)'))

stopCluster(cl)

```

AIC model selection table (smoothed terms not included):

```{r, echo=FALSE}
mod_sel[1:10,] %>% 
  as.data.frame() %>% 
  select(`(Intercept)`, wnd_mean_lag1:weight) %>% 
  round(3)
```

Best model includes two lagged wind speed terms. Re-fit final model:

```{r, eval=FALSE}
form_best <- formula(kz_hobo ~
                       s(site, bs = "re")+
                       s(wnd_mean)+
                       wnd_mean_lag1+
                       wnd_mean_lag2+
                       s(wnd_dir, bs = "cc", k=15)+
                       ti(wnd_mean, wnd_dir, bs=c("tp", "cc"))+
                       s(doy, by=year_fact, k=15)+
                       year)

gam_best <- gamm(form_best, 
                 correlation = corCAR1(form = ~ as.numeric(date)|site),
                 data = model_df)
```

## Inspecting the selected GAM 

Model summary:

```{r, echo=FALSE}
summary(gam_best$gam)
```

Residual diagnostic plots:

```{r, echo=FALSE}
par(mfrow=c(2,2))  
gam.check(gam_best$gam) 
```

ACF plot:

```{r}
acf(resid(gam_best$lme, type = "normalized"), main="")
```

PACF plot:

```{r}
pacf(resid(gam_best$lme, type = "normalized"), main="")
```

Variogram plot:

```{r}
plot(Variogram(gam_best$lme, form = ~ as.numeric(date)|site, data = model_df), ylim = c(0, 1.5))
```

Plot of model smooth terms:

```{r, fig.width=10, fig.height=10, echo=FALSE}
viz <- getViz(gam_best$gam)
print(plot(viz), pages = 1)
```
